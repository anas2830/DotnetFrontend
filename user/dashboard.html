<!DOCTYPE html>
<html>
<head>
    <title>User Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f5f6fa;
        }
        .sidebar {
            height: 100vh;
            background: #0d6efd;
            color: #fff;
        }
        .sidebar a {
            color: #fff;
            text-decoration: none;
            padding: 12px 15px;
            display: block;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(255,255,255,0.2);
        }
        .card-stat {
            border: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.08);
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
            <h5 class="text-center py-3 border-bottom">User Panel</h5>

            <a href="/user/dashboard.html" class="active" onclick="showSection('dashboard')">Dashboard</a>
            <a href="/user/exam-list.html" onclick="showSection('allExams')">Exams List</a>
            <a href="/user/profile.html" onclick="showSection('profile')">My Profile</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 p-4">

            <!-- Dashboard -->
            <div id="dashboard">
                <h4 class="mb-4">Dashboard</h4>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card card-stat p-3 text-center">
                            <h6>Total Exams Purchased</h6>
                            <h3 id="totalPurchased">0</h3>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-stat p-3 text-center">
                            <h6>Exams Attempted</h6>
                            <h3 id="attemptedExams">0</h3>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-stat p-3 text-center">
                            <h6>Remaining Exams</h6>
                            <h3 id="remainingExams">0</h3>
                        </div>
                    </div>
                </div>

                <div class="card card-stat">
                    <div class="card-header bg-white">
                        <strong>My Exams List</strong>
                    </div>
                    <div class="card-body p-0">
                        <table class="table mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Exam Name</th>
                                    <th>Date</th>
                                    <th>Paid Amount</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="recentExams"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- All Exams -->
            <div id="allExams" class="d-none">
                <h4>All Exams</h4>
                <div id="allExamList" class="row"></div>
            </div>

            <!-- My Exams -->
            <div id="myExams" class="d-none">
                <h4>My Exams</h4>
                <div id="myExamList" class="row"></div>
            </div>

            <!-- Profile -->
            <div id="profile" class="d-none">
                <h4>My Profile</h4>
                <input class="form-control mb-2" id="userName">
                <button class="btn btn-primary" onclick="updateProfile()">Update</button>
            </div>

        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "../index.html";
    
    // Fetch user dashboard data
    async function loadDashboard() {
        try {
            const res = await fetch("http://localhost:5223/api/user/dashboard", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });
    
            if (!res.ok) {
                const err = await res.json();
                alert(err.message || "Failed to load dashboard");
                return;
            }
    
            const data = await res.json();
            renderDashboard(data);
        } catch (err) {
            console.error(err);
            alert("Error fetching dashboard");
        }
    }
    
    // Render dashboard stats & exams table
    function renderDashboard(data) {
        // Stats
        document.getElementById("totalPurchased").textContent = data.totalPurchased ?? 0;
        document.getElementById("attemptedExams").textContent = data.totalSubmitted ?? 0;
        document.getElementById("remainingExams").textContent = data.remainingExams ?? 0;
    
        // Recent exams table
        const tbody = document.getElementById("recentExams");
        tbody.innerHTML = "";
    
        if (data.exams && data.exams.length) {
            data.exams.forEach((exam, index) => {
                let actionHTML = "";
    
                if (exam.status === "Submitted") {
                    actionHTML = `<a target="_blank" href="/user/summary-report.html?userExamId=${exam.userExamId}" class="btn btn-success btn-sm">View Report</a>`;
                } else if (exam.status === "Booked" || exam.status === "Started") {
                    actionHTML = `<a href="/user/start-exam.html?examId=${exam.examId}" class="btn btn-primary btn-sm">Go to Exam</a>`;
                } else {
                    actionHTML = `<button class="btn btn-secondary btn-sm" disabled>Not Available</button>`;
                }
    
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${exam.title}</td>
                        <td>${formatExamDate(exam.date.split('T')[0])}</td>
                        <td>${exam.paidAmount}</td>
                        <td>${exam.status}</td>
                        <td>${actionHTML}</td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center">No exams found</td></tr>`;
        }
    }

    function formatExamDate(isoDate) {
        if (!isoDate) return "-";
        const d = new Date(isoDate);
        const options = { day: '2-digit', month: 'short', year: 'numeric' };
        return d.toLocaleDateString('en-US', options); // "30 Jan, 2026"
    }
    
    // Load dashboard on page load
    document.addEventListener("DOMContentLoaded", loadDashboard);
</script>
    

</body>
</html>
